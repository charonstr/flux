<!doctype html>
<html lang="{{ current }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Casino Başarımlar - Euphorium</title>
    <link rel="stylesheet" href="/mobile/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .ach-wrap { width: min(100%, 1100px); margin: 0 auto; padding: 14px; padding-bottom: calc(var(--bottom-nav-height, 78px) + env(safe-area-inset-bottom, 0px) + 14px); }
        .ach-head { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 12px; }
        .ach-head h1 { margin: 0; font-size: 1.1rem; display: flex; gap: 8px; align-items: center; }
        .ach-head a { text-decoration: none; padding: 8px 10px; font-size: 0.86rem; }
        .ach-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .ach-card { border: 1px solid rgba(var(--line-rgb), 0.35); background: rgba(var(--panel-rgb), 0.7); border-radius: 12px; padding: 12px; }
        .ach-title { display: flex; align-items: center; justify-content: space-between; gap: 8px; font-weight: 800; font-size: 0.95rem; }
        .ach-state { font-size: 0.74rem; padding: 4px 8px; border-radius: 999px; white-space: nowrap; }
        .ach-state.done { background: rgba(16,185,129,0.2); color: #10b981; border: 1px solid rgba(16,185,129,0.45); }
        .ach-state.locked { background: rgba(239,68,68,0.16); color: #f87171; border: 1px solid rgba(239,68,68,0.4); }
        .ach-desc { color: var(--muted); margin-top: 8px; font-size: 0.86rem; }
        .ach-progress { margin-top: 8px; font-size: 0.78rem; color: var(--muted); }
        .track { margin-top: 6px; height: 8px; background: rgba(0,0,0,0.35); border-radius: 999px; overflow: hidden; }
        .fill { height: 100%; background: linear-gradient(90deg, #10b981, #22c55e); width: 0%; transition: width 0.35s ease; }
        .stat-line { margin-top: 8px; color: var(--muted); font-size: 0.84rem; }
        .claim-btn { margin-top: 8px; }
    </style>
</head>
<body>
    <main class="ach-wrap">
        <div class="ach-head">
            <h1><i class="fa-solid fa-trophy"></i> Casino Başarımları</h1>
            <a class="pickbtn" href="/casino" data-nav="soft">Geri</a>
        </div>
        <div class="ach-card">
            <div class="ach-title">Genel Durum</div>
            <div class="stat-line" id="summaryLine">Yükleniyor...</div>
        </div>
        <div id="achGrid" class="ach-grid" style="margin-top:10px;"></div>
    </main>

    <script src="/mobile/js/app.js"></script>
    <script>
        window.initCasinoAchievementsPage = async function () {
            if (!document.getElementById("achGrid")) return;
            function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }
            function esc(v) { return String(v || "").replace(/[&<>"']/g, c => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" })[c]); }
            try {
                const res = await fetch("/api/casino/achievements/state", { headers: { "X-Requested-With": "fetch" }, cache: "no-store" });
                const data = await res.json();
                if (!data || !data.ok || !Array.isArray(data.achievements)) return;

                const list = data.achievements.slice(0, 10);
                const doneCount = list.filter(a => Boolean(a.can_claim)).length;
                const line = document.getElementById("summaryLine");
                if (line) line.textContent = "Toplam görev: " + list.length + " | Ödüle hazır görev: " + doneCount;

                const wrap = document.getElementById("achGrid");
                wrap.innerHTML = list.map((a) => {
                    const percent = clamp((Number(a.progress_value || 0) * 100) / Math.max(1, Number(a.target_value || 1)), 0, 100);
                    const done = Number(a.progress_total_value || 0) >= Number(a.target_value || 0);
                    return '<section class="ach-card">'
                        + '<div class="ach-title"><span><i class="fa-solid fa-medal" style="margin-right:8px;color:var(--primary);"></i>' + esc(a.title) + '</span>'
                        + '<span class="ach-state ' + (done ? "done" : "locked") + '">' + (done ? "Tamamlandı" : "Kilitli") + '</span></div>'
                        + '<div class="ach-desc">' + esc(a.description || "") + '</div>'
                        + '<div class="ach-progress">' + esc(Math.floor(Number(a.progress_value || 0)) + " / " + Math.floor(Number(a.target_value || 0))) + '</div>'
                        + '<div class="track"><div class="fill" style="width:' + percent + '%"></div></div>'
                        + '<div class="stat-line">Ödül: +' + Number(a.reward_gold || 0) + ' gold</div>'
                        + '<button class="pickbtn claim-btn" ' + (a.can_claim ? '' : 'disabled') + ' onclick="window.claimCasinoAchievement(\'' + esc(a.key) + '\')">Ödülü Al</button>'
                        + '<div class="stat-line" id="msg-' + esc(a.key) + '"></div>'
                        + '</section>';
                }).join("");
            } catch (_) {}
        };

        window.claimCasinoAchievement = async function (key) {
            const msg = document.getElementById("msg-" + key);
            if (msg) msg.textContent = "İşleniyor...";
            try {
                const res = await fetch("/api/casino/achievements/claim", {
                    method: "POST",
                    headers: { "X-Requested-With": "fetch", "Content-Type": "application/json" },
                    body: JSON.stringify({ achievement_key: key })
                });
                const data = await res.json();
                if (!res.ok || !data || !data.ok) {
                    if (msg) msg.textContent = "Henüz ödül alınamaz";
                    await window.initCasinoAchievementsPage();
                    return;
                }
                if (msg) msg.textContent = "+" + Number(data.claimed_amount || 0) + " gold alındı";
                await window.initCasinoAchievementsPage();
            } catch (_) {
                if (msg) msg.textContent = "İşlem başarısız";
                await window.initCasinoAchievementsPage();
            }
        };

        window.initCasinoAchievementsPage();
        window.addEventListener("spa-loaded", window.initCasinoAchievementsPage);
    </script>
</body>
</html>
