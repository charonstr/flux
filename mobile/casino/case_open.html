<!doctype html>
<html lang="{{ current }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kasa Açılımı - Euphorium</title>
  <link rel="stylesheet" href="/mobile/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .case-wrap { max-width: 1200px; margin: 0 auto; padding: 16px 12px; }
    
    .case-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; gap: 10px; flex-wrap: wrap; }
    .header-left { display: flex; align-items: center; gap: 10px; }
    .header-left h1 { margin: 0; font-size: 1.25rem; color: var(--text); line-height: 1.1; }
    .balance-badge { display: flex; align-items: center; gap: 6px; background: rgba(245, 158, 11, 0.1); color: #f59e0b; padding: 7px 12px; border-radius: 10px; font-weight: 800; font-size: 0.95rem; border: 1px solid rgba(245, 158, 11, 0.2); }

    .controls-panel { background: var(--panel); border: 1px solid var(--line); border-radius: 14px; padding: 12px; margin-bottom: 12px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    
    .actions-row { display: flex; align-items: center; justify-content: center; gap: 10px; flex-wrap: wrap; }
    
    .qty-picker { display: flex; gap: 6px; background: var(--bg); padding: 4px; border-radius: 12px; border: 1px solid var(--line); }
    .qty-picker button { width: 40px; height: 40px; border-radius: 9px; border: none; background: transparent; color: var(--muted); font-size: 0.95rem; font-weight: 800; cursor: pointer; transition: all 0.2s; }
    .qty-picker button:hover { background: rgba(var(--text-rgb), 0.05); color: var(--text); }
    .qty-picker button.active { background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(var(--primary-rgb), 0.3); }

    .open-btn { padding: 0 20px; height: 48px; border-radius: 12px; border: none; font-size: 1rem; font-weight: 900; background: linear-gradient(135deg, #10b981, #059669); color: #fff; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
    .open-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4); }
    .open-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; background: var(--muted); }

    .stats-row { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; padding-top: 10px; border-top: 1px solid var(--line); }
    .stat-badge { display: flex; align-items: center; gap: 5px; padding: 5px 10px; border-radius: 8px; font-weight: 700; font-size: 0.82rem; }
    .stat-win { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .stat-lose { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
    .stat-net { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }

    /* YENİ EKRANA SIĞAN GRID/FLEX TASARIMI (2x2 + 1 Ortada) */
    .lane-stack {
        --item-width: 160px;
        display: flex; 
        flex-wrap: wrap; 
        justify-content: center; 
        gap: 10px;
        margin-bottom: 12px;
        width: 100%; 
        min-width: 0; 
    }
    
    .lane { 
        flex: 0 0 calc(50% - 8px); /* Yan yana 2 adet sığması için */
        max-width: calc(50% - 8px);
        height: 132px;
        background: #0f172a; 
        border: 2px solid var(--line); 
        border-radius: 12px; 
        overflow: hidden; 
        position: relative; 
        min-width: 0; 
        box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
    }

    /* Eğer sadece 1 kasa seçiliyse tam genişlikte dursun */
    .lane:only-child {
        flex: 0 0 100%;
        max-width: 100%;
        height: 180px;
    }

    .line { position: absolute; left: 50%; top: 0; width: 3px; height: 100%; transform: translateX(-50%); background: #facc15; z-index: 10; box-shadow: 0 0 10px #facc15, 0 0 4px #facc15; }
    .track { display: flex; height: 100%; width: max-content; will-change: transform; transform: translate3d(0,0,0); backface-visibility: hidden; }
    .item { 
        width: var(--item-width); height: 100%; flex-shrink: 0;
        display: flex; flex-direction: column; justify-content: center; align-items: center; 
        border-bottom: 6px solid; 
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.3)); 
        padding: 8px;
    }
    .item img { max-width: 80%; max-height: 70px; object-fit: contain; pointer-events: none; user-select: none; filter: drop-shadow(0 8px 8px rgba(0,0,0,0.5)); }
    .item .n { font-size: 0.72rem; font-weight: 700; margin-top: 6px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; max-width: 100%; color: #f8fafc; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

    .grid-panels { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .panel-box { background: var(--panel); border: 1px solid var(--line); border-radius: 14px; padding: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .panel-box h3 { margin-top: 0; border-bottom: 1px solid var(--line); padding-bottom: 7px; margin-bottom: 9px; font-size: 0.96rem; display: flex; align-items: center; gap: 8px; color: var(--text); }
    
    .odds-row { display: flex; justify-content: space-between; padding: 6px 8px; border-radius: 8px; margin-bottom: 4px; background: var(--bg); font-weight: 600; color: var(--text); font-size: 0.82rem; }
    .history-row { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; padding: 7px; border-bottom: 1px solid var(--line); align-items: center; color: var(--text); }
    .history-row:last-child { border-bottom: none; }
    .history-row img { height: 30px; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }
    .history-row-name { font-weight: 700; font-size: 0.82rem; }
    .history-row-price { font-weight: 800; color: #10b981; font-size: 0.82rem; }

    /* Mobilde alt alta olması için kurallar */
    @media (max-width: 860px) {
        .lane-stack { --item-width: 150px; }
        .grid-panels { grid-template-columns: 1fr; } 
        .actions-row { flex-direction: column; width: 100%; }
        .open-btn { width: 100%; }
        .lane { flex: 0 0 100%; max-width: 100%; }
    }
    @media (max-width: 480px) {
        .lane-stack { --item-width: 136px; }
        .case-header { margin-bottom: 8px; }
        .header-left h1 { font-size: 1.05rem; }
        .balance-badge { font-size: 0.85rem; padding: 6px 10px; }
        .qty-picker button { width: 34px; height: 34px; font-size: 0.82rem; }
        .open-btn { height: 42px; font-size: 0.9rem; }
        .lane { height: 116px; }
        .item img { max-height: 58px; }
    }
  </style>
</head>
<body>
  <main class="case-wrap">
    <div class="case-header">
      <div class="header-left">
        <a href="/casino/case" data-nav="soft" class="navbtn"><i class="fa-solid fa-arrow-left"></i></a>
        <h1 id="title">Kasa Yükleniyor...</h1>
      </div>
      <div class="balance-badge"><i class="fa-solid fa-coins"></i> <span id="balance">0</span></div>
    </div>

    <section class="controls-panel">
      <div class="actions-row">
        <div class="qty-picker" id="qtyPicker">
          <button type="button" data-q="1" class="active">1</button>
          <button type="button" data-q="2">2</button>
          <button type="button" data-q="3">3</button>
          <button type="button" data-q="4">4</button>
          <button type="button" data-q="5">5</button>
        </div>
        <button id="openBtn" class="open-btn" type="button"><i class="fa-solid fa-unlock-keyhole" style="margin-right:8px;"></i> Aç</button>
      </div>
      
      <div class="stats-row">
        <div class="stat-badge stat-win">Toplam Kazanç: <span id="sumWin">0</span></div>
        <div class="stat-badge stat-lose">Toplam Zarar: <span id="sumLose">0</span></div>
        <div class="stat-badge stat-net">Net: <span id="sumNet">0</span></div>
      </div>
    </section>

    <section id="laneStack" class="lane-stack"></section>

    <div class="grid-panels">
      <section class="panel-box">
        <h3><i class="fa-solid fa-percent" style="color:var(--primary);"></i> Oranlar</h3>
        <div id="odds"></div>
      </section>
      <section class="panel-box">
        <h3><i class="fa-solid fa-clock-rotate-left" style="color:var(--primary);"></i> Son Çıkanlar</h3>
        <div id="history"></div>
      </section>
    </div>
  </main>

  <script src="/mobile/js/app.js"></script>
  <script>
    (function(){
      const caseId = {{ caseid|tojson }};
      const laneStack = document.getElementById('laneStack');
      const openBtn = document.getElementById('openBtn');
      const balanceEl = document.getElementById('balance');
      const titleEl = document.getElementById('title');
      const oddsEl = document.getElementById('odds');
      const historyEl = document.getElementById('history');
      const qtyPicker = document.getElementById('qtyPicker');
      const sumWinEl = document.getElementById('sumWin');
      const sumLoseEl = document.getElementById('sumLose');
      const sumNetEl = document.getElementById('sumNet');

      let constants = { case: { price: 0 }, items: [] };
      let balance = 0;
      let busy = false;
      let quantity = 1;
      let totalWin = 0;
      let totalLose = 0;

      function idem(){ return 'case_' + Date.now() + '_' + Math.random().toString(16).slice(2,10); }
      function rItem(item){ return '<div class="item" style="border-color:' + item.color + '"><img src="' + item.img + '" alt=""><div class="n" style="color:' + item.color + '">' + item.name + '</div></div>'; }
      function syncButton(){
        const total = Number(constants.case?.price || 0) * quantity;
        openBtn.innerHTML = '<i class="fa-solid fa-unlock-keyhole" style="margin-right:8px;"></i> ' + quantity + 'x Aç (' + total + ' Altın)';
        openBtn.disabled = busy || balance < total;
      }
      function renderTotals(){
        if (sumWinEl) sumWinEl.textContent = String(totalWin);
        if (sumLoseEl) sumLoseEl.textContent = String(totalLose);
        if (sumNetEl) sumNetEl.textContent = String(totalWin - totalLose);
      }

      function setQuantity(q){
        quantity = Math.max(1, Math.min(5, Number(q || 1)));
        qtyPicker.querySelectorAll('button[data-q]').forEach(function(b){ b.classList.toggle('active', Number(b.dataset.q) === quantity); });
        buildLanes(quantity);
        syncButton();
      }

      function buildLanes(count){
        let html = '';
        for(let i=0;i<count;i++){
          html += '<div class="lane" data-lane="' + i + '"><div class="line"></div><div class="track" data-track="' + i + '"></div></div>';
        }
        laneStack.innerHTML = html;
        fillDummy();
      }

      function tracks(){ return Array.from(laneStack.querySelectorAll('.track')); }

      function fillDummy(){
        tracks().forEach(function(t){
          let html = '';
          for(let i=0;i<45;i++){
            const items = constants.items || [];
            if(items.length){ const x = items[Math.floor(Math.random()*items.length)]; html += rItem(x); }
            else { html += '<div class="item" style="border-color:#4b69ff"><div class="n">?</div></div>'; }
          }
          t.innerHTML = html;
          t.style.transition='none';
          t.style.transform='translateX(0px)';
        });
      }

      function renderOdds(){
        const m = new Map();
        (constants.items || []).forEach(function(i){ if(!m.has(i.rarity)) m.set(i.rarity,{w:0,c:i.color}); m.get(i.rarity).w += Number(i.weight || 0); });
        oddsEl.innerHTML = Array.from(m.entries()).map(function(e){ return '<div class="odds-row"><span style="color:'+e[1].c+'">'+e[0]+'</span><b>%'+e[1].w.toFixed(4)+'</b></div>'; }).join('');
      }

      function renderHistory(rows){
        if(!rows || !rows.length){ historyEl.innerHTML = '<div style="padding:10px; color:var(--muted);">Geçmiş yok</div>'; return; }
        historyEl.innerHTML = rows.slice(0, 3).map(function(r){ return '<div class="history-row"><div><img src="'+r.item.img+'" alt=""></div><div class="history-row-name" style="color:'+r.item.color+'">'+r.item.name+'</div><div class="history-row-price">+' + Number(r.payout||0) + '</div></div>'; }).join('');
      }

      async function waitTrackImages(track, maxWaitMs){
        const imgs = Array.from(track.querySelectorAll('img'));
        if(!imgs.length) return;
        const tasks = imgs.map(function(img){
          if (img.complete) return Promise.resolve();
          return new Promise(function(resolve){
            const done = function(){ resolve(); };
            img.addEventListener('load', done, { once: true });
            img.addEventListener('error', done, { once: true });
          });
        });
        await Promise.race([
          Promise.all(tasks),
          new Promise(function(resolve){ setTimeout(resolve, maxWaitMs || 900); })
        ]);
      }

      async function loadState(){
        const res = await fetch('/api/casino/case/state?case=' + encodeURIComponent(caseId), { headers:{'X-Requested-With':'fetch'}, cache:'no-store' });
        const data = await res.json();
        if(!res.ok || !data.ok) return;
        constants = data.constants || constants;
        balance = Number(data.balance || 0);
        balanceEl.textContent = String(balance);
        titleEl.textContent = String(constants.case?.name || 'Kasa');
        renderOdds();
        renderHistory(data.history || []);
        buildLanes(quantity);
        syncButton();
      }

      async function openSingle(){
        const res = await fetch('/api/casino/case/open', {
          method:'POST',
          headers:{'Content-Type':'application/json','X-Requested-With':'fetch'},
          body: JSON.stringify({ case: caseId, idempotency_key: idem() })
        });
        const data = await res.json();
        return { ok: res.ok && data && data.ok, data: data || {} };
      }

      async function animateLane(track, state, delayMs){
        track.innerHTML = (state.sequence || []).map(rItem).join('');
        await waitTrackImages(track, 1000);
        await new Promise(function(r){ setTimeout(r, delayMs || 0); });

        track.style.transition = 'none';
        track.style.transform = 'translateX(0px)';
        void track.offsetWidth;

        const firstItem = track.querySelector('.item');
        const itemWidth = firstItem ? firstItem.getBoundingClientRect().width : 180;
        const winnerIndex = 35;
        const lane = track.parentElement;
        const containerWidth = lane ? lane.offsetWidth : 1000;
        const targetX = -(winnerIndex * itemWidth) + (containerWidth / 2) - (itemWidth / 2) + (Math.floor(Math.random()*160)-80);

        track.style.transition = 'transform 6s cubic-bezier(0.1, 0.9, 0.2, 1)';
        track.style.transform = 'translateX(' + targetX + 'px)';

        await new Promise(function(r){ setTimeout(r, 6100); });
      }

      async function openCases(){
        if(busy) return;
        const casePrice = Number(constants.case?.price || 0);
        const total = casePrice * quantity;
        if(balance < total) return;

        busy = true;
        balance = Math.max(0, balance - total);
        balanceEl.textContent = String(balance);
        syncButton();

        const laneTracks = tracks();
        const results = [];

        for(let i=0;i<quantity;i++){
          const r = await openSingle();
          results.push(r);
        }

        let refund = 0;
        const animJobs = [];

        results.forEach(function(r, i){
          if(!r.ok){ refund += casePrice; return; }
          const st = r.data.state || {};
          const t = laneTracks[i];
          if(!t){ refund += casePrice; return; }
          animJobs.push((async function(){
            await animateLane(t, st, i * 120);
            const payout = Number(st.payout || 0);
            const delta = payout - casePrice;
            if (delta >= 0) totalWin += delta;
            else totalLose += Math.abs(delta);
            renderTotals();
            balance += payout;
            balanceEl.textContent = String(balance);
          })());
        });

        if(refund > 0){
          balance += refund;
          balanceEl.textContent = String(balance);
        }

        await Promise.all(animJobs);
        await loadState().catch(function(){});

        busy = false;
        syncButton();
      }

      qtyPicker.addEventListener('click', function(e){
        const btn = e.target.closest('button[data-q]');
        if(!btn || busy) return;
        setQuantity(btn.dataset.q);
      });

      openBtn.addEventListener('click', openCases);
      loadState().then(function(){ setQuantity(1); renderTotals(); }).catch(function(){});
    })();
  </script>
</body>
</html>
