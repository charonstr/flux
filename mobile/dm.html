<!DOCTYPE html>
<html lang="{{ current }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ t.dm }} - Euphorium</title>
    <link rel="stylesheet" href="/mobile/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <main>
        <div class="wrap">
            {% if peer %}
            <div class="panel" id="dmpage" data-peer="{{ peer.id }}" data-convid="{{ convid }}" data-last="{{ lastid }}">
                <div class="sidebar">
                    <a href="/dm" class="navbtn" data-nav="soft"><i class="fa-solid fa-arrow-left"></i></a>
                    <a href="/profile" class="profilebadge">
                        <img src="{{ peer.avatar }}" class="avatar sm">
                        <span>{{ peer.username }}</span>
                    </a>
                    <div style="flex:1"></div>
                </div>

                <div class="chatbox">
                    {% for msg in messages %}
                    <div class="msg" data-mid="{{ msg.id }}">
                        <div style="font-weight:600; font-size:0.85rem; color:var(--primary);">{{ msg.author }}</div>
                        {% if msg.type == 'text' %}{{ msg.content }}{% endif %}
                        {% if msg.type == 'image' %}<img src="/media/{{ msg.file }}" class="chatimg" loading="lazy">{% endif %}
                    </div>
                    {% endfor %}
                </div>

                <form class="form" method="POST" enctype="multipart/form-data" style="margin-top:10px;">
                    <div class="input-group">
                        <i class="fa-solid fa-comment"></i>
                        <input type="text" name="text" placeholder="{{ t.message }}..." autocomplete="off">
                    </div>
                    <div class="acts">
                        <label class="linkbtn" style="flex:1;">
                            <i class="fa-solid fa-paperclip"></i>
                            <input type="file" name="file" style="display:none;">
                        </label>
                        <button class="pickbtn" style="flex:1;"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </form>
            </div>
            {% else %}
            <div class="panel">
                <div class="sidebar">
                    <h2>{{ t.dmbox }}</h2>
                    <div class="topnav">
                        <form action="/dm/start" method="POST" style="display:flex; gap:5px; width:100%;">
                            <input type="text" name="username" placeholder="{{ t.startbyname }}" style="padding:8px 12px; font-size:0.9rem;">
                            <button class="pickbtn" style="padding:8px 12px;"><i class="fa-solid fa-plus"></i></button>
                        </form>
                    </div>
                </div>
                
                {% if error %}<div class="error">{{ error }}</div>{% endif %}
                
                <div style="margin-top: 10px;">
                    <h4 style="margin-bottom: 8px; color: var(--muted); font-size: 0.8rem; text-transform: uppercase;">{{ t.active_chats }}</h4>
                    {% for p in peers %}
                    <a href="/dm/{{ p.id }}" class="cardrow modal-link" data-nav="soft">
                        <img src="{{ p.avatar }}" class="avatar">
                        <div style="flex:1;">
                            <div style="font-weight:600;">{{ p.username }}</div>
                            <div style="font-size:0.85rem; color:var(--muted); text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">{{ p.status }}</div>
                        </div>
                        {% if p.unread > 0 %}<span style="background:var(--primary); color:#fff; padding:2px 8px; border-radius:10px; font-size:0.8rem;">{{ p.unread }}</span>{% endif %}
                    </a>
                    {% endfor %}
                </div>

                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 8px; color: var(--muted); font-size: 0.8rem; text-transform: uppercase;">{{ t.friends }}</h4>
                    {% for f in friends %}
                    <a href="/dm/{{ f.id }}" class="cardrow modal-link" data-nav="soft">
                        <img src="{{ f.avatar }}" class="avatar">
                        <div style="flex:1;">
                            <div style="font-weight:600;">{{ f.username }}</div>
                            <div style="font-size:0.85rem; color:var(--primary);">{{ t.click_to_chat }}</div>
                        </div>
                        <i class="fa-solid fa-message" style="color: var(--muted);"></i>
                    </a>
                    {% else %}
                    <p class="hint" style="text-align:center; padding: 10px;">{{ t.nofriends }}</p>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </main>
    <script src="/mobile/js/app.js"></script>
</body>
</html>